<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strateji Test Sistemi - Crypto Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .strategy-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .test-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .metric-positive {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        
        .metric-negative {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        }
        
        .metric-neutral {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .performance-grade {
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .recommendation-item {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .signal-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
        }
        
        .signal-buy {
            background: #4CAF50;
            color: white;
        }
        
        .signal-sell {
            background: #f44336;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .tabs-container {
            margin-top: 20px;
        }
        
        .quick-test-btn {
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .quick-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .full-test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .full-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .save-strategy-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
            padding: 15px 40px;
            font-weight: bold;
            border-radius: 30px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .save-strategy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        
        .activate-strategy-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border: none;
            color: white;
            padding: 15px 40px;
            font-weight: bold;
            border-radius: 30px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .activate-strategy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line"></i> Crypto Trading Bot
            </a>
            <span class="navbar-text">
                Strateji Test Sistemi
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="strategy-card">
                    <h3><i class="fas fa-cogs"></i> Strateji Konfigürasyonu</h3>
                    
                    <form id="strategyForm">
                        <div class="mb-3">
                            <label for="strategyType" class="form-label">Strateji Tipi</label>
                            <select class="form-select" id="strategyType">
                                <option value="quality_over_quantity">Kalite Odaklı</option>
                                <option value="trend_momentum">Trend Momentum</option>
                                <option value="volatility_breakout">Volatilite Breakout</option>
                                <option value="signal_rich">Sinyal Zengin</option>
                                <option value="trend_following">Trend Takibi</option>
                                <option value="mean_reversion">Ortalamaya Dönüş</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="symbol" class="form-label">Kripto Para</label>
                            <select class="form-select" id="symbol">
                                <option value="BTCUSDT">Bitcoin (BTC)</option>
                                <option value="ETHUSDT">Ethereum (ETH)</option>
                                <option value="LINKUSDT">Chainlink (LINK)</option>
                                <option value="SOLUSDT">Solana (SOL)</option>
                                <option value="DOTUSDT">Polkadot (DOT)</option>
                                <option value="XRPUSDT">XRP (XRP)</option>
                                <option value="BNBUSDT">Binance Coin (BNB)</option>
                                <option value="ADAUSDT">Cardano (ADA)</option>
                                <option value="AVAXUSDT">Avalanche (AVAX)</option>
                                <option value="MATICUSDT">Polygon (MATIC)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="positionSize" class="form-label">Pozisyon Boyutu (%)</label>
                            <input type="range" class="form-range" id="positionSize" min="1" max="25" value="5">
                            <div class="d-flex justify-content-between">
                                <small>1%</small>
                                <small id="positionSizeValue">5%</small>
                                <small>25%</small>
                            </div>
                        </div>

                        <!-- Bollinger Bands Parameters -->
                        <h5><i class="fas fa-chart-area"></i> Bollinger Bands</h5>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="bbPeriod" class="form-label">Periyot</label>
                                <input type="number" class="form-control" id="bbPeriod" value="20" min="5" max="50">
                            </div>
                            <div class="col-6">
                                <label for="bbStd" class="form-label">Standart Sapma</label>
                                <input type="number" class="form-control" id="bbStd" value="2.0" min="1.0" max="3.5" step="0.1">
                            </div>
                        </div>

                        <!-- MACD Parameters -->
                        <h5><i class="fas fa-wave-square"></i> MACD</h5>
                        <div class="row mb-3">
                            <div class="col-4">
                                <label for="macdFast" class="form-label">Hızlı</label>
                                <input type="number" class="form-control" id="macdFast" value="12" min="3" max="20">
                            </div>
                            <div class="col-4">
                                <label for="macdSlow" class="form-label">Yavaş</label>
                                <input type="number" class="form-control" id="macdSlow" value="26" min="15" max="50">
                            </div>
                            <div class="col-4">
                                <label for="macdSignal" class="form-label">Sinyal</label>
                                <input type="number" class="form-control" id="macdSignal" value="9" min="3" max="15">
                            </div>
                        </div>

                        <!-- RSI Parameters -->
                        <h5><i class="fas fa-thermometer-half"></i> RSI</h5>
                        <div class="row mb-3">
                            <div class="col-4">
                                <label for="rsiPeriod" class="form-label">Periyot</label>
                                <input type="number" class="form-control" id="rsiPeriod" value="14" min="3" max="30">
                            </div>
                            <div class="col-4">
                                <label for="rsiOverbought" class="form-label">Aşırı Alım</label>
                                <input type="number" class="form-control" id="rsiOverbought" value="70" min="55" max="90">
                            </div>
                            <div class="col-4">
                                <label for="rsiOversold" class="form-label">Aşırı Satım</label>
                                <input type="number" class="form-control" id="rsiOversold" value="30" min="10" max="45">
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn quick-test-btn" id="quickTestBtn">
                                <i class="fas fa-bolt"></i> Hızlı Test (30 Gün)
                            </button>
                            <button type="button" class="btn full-test-btn" id="fullTestBtn">
                                <i class="fas fa-chart-line"></i> Detaylı Test (90 Gün)
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-md-6">
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Test ediliyor...</span>
                    </div>
                    <h4 class="mt-3">Strateji test ediliyor...</h4>
                    <p>Bu işlem birkaç dakika sürebilir.</p>
                </div>

                <div id="testResults" class="test-results" style="display: none;">
                    <h3><i class="fas fa-chart-bar"></i> Test Sonuçları</h3>
                    
                    <div class="row" id="metricsCards">
                        <!-- Metrics will be populated by JavaScript -->
                    </div>

                    <div class="tabs-container">
                        <ul class="nav nav-tabs" id="resultTabs">
                            <li class="nav-item">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview">
                                    <i class="fas fa-tachometer-alt"></i> Genel Bakış
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="signals-tab" data-bs-toggle="tab" data-bs-target="#signals">
                                    <i class="fas fa-signal"></i> Sinyaller
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart">
                                    <i class="fas fa-chart-line"></i> Grafik
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations">
                                    <i class="fas fa-lightbulb"></i> Öneriler
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="resultTabsContent">
                            <div class="tab-pane fade show active" id="overview">
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>Performans Özeti</h5>
                                            <div id="performanceSummary"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>Risk Analizi</h5>
                                            <div id="riskAnalysis"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="signals">
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>Sinyal İstatistikleri</h5>
                                            <div id="signalStats"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>Son Sinyaller</h5>
                                            <div id="recentSignals"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="chart">
                                <div class="chart-container">
                                    <canvas id="priceChart"></canvas>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="recommendations">
                                <div class="mt-3">
                                    <h5>İyileştirme Önerileri</h5>
                                    <div id="recommendationsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 text-center" id="actionButtons" style="display: none;">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="button" class="btn save-strategy-btn me-md-2" id="saveStrategyBtn">
                                <i class="fas fa-save"></i> Stratejiyi Kaydet
                            </button>
                            <button type="button" class="btn activate-strategy-btn" id="activateStrategyBtn" style="display: none;">
                                <i class="fas fa-play"></i> Stratejiyi Aktifleştir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Strategy Modal -->
    <div class="modal fade" id="saveStrategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-save"></i> Stratejiyi Kaydet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="saveStrategyForm">
                        <div class="mb-3">
                            <label for="strategyName" class="form-label">Strateji Adı</label>
                            <input type="text" class="form-control" id="strategyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="strategyDescription" class="form-label">Açıklama (İsteğe bağlı)</label>
                            <textarea class="form-control" id="strategyDescription" rows="3"></textarea>
                        </div>
                        <div id="saveWarnings"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="confirmSaveBtn">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTestResults = null;
        let currentStrategyConfig = null;
        let priceChart = null;

        // Update position size display
        document.getElementById('positionSize').addEventListener('input', function() {
            document.getElementById('positionSizeValue').textContent = this.value + '%';
        });

        // Quick test button
        document.getElementById('quickTestBtn').addEventListener('click', function() {
            runStrategyTest(true);
        });

        // Full test button
        document.getElementById('fullTestBtn').addEventListener('click', function() {
            runStrategyTest(false);
        });

        // Save strategy button
        document.getElementById('saveStrategyBtn').addEventListener('click', function() {
            if (currentTestResults) {
                showSaveStrategyModal();
            }
        });

        // Confirm save button
        document.getElementById('confirmSaveBtn').addEventListener('click', function() {
            saveStrategy();
        });

        function getStrategyConfig() {
            const config = {
                strategy_type: document.getElementById('strategyType').value,
                indicators: {
                    bollinger_bands: {
                        period: parseInt(document.getElementById('bbPeriod').value),
                        std_dev: parseFloat(document.getElementById('bbStd').value)
                    },
                    macd: {
                        fast: parseInt(document.getElementById('macdFast').value),
                        slow: parseInt(document.getElementById('macdSlow').value),
                        signal: parseInt(document.getElementById('macdSignal').value)
                    },
                    rsi: {
                        period: parseInt(document.getElementById('rsiPeriod').value),
                        overbought: parseFloat(document.getElementById('rsiOverbought').value),
                        oversold: parseFloat(document.getElementById('rsiOversold').value)
                    }
                },
                risk_management: {
                    position_size_pct: parseFloat(document.getElementById('positionSize').value) / 100
                },
                filters: {
                    volume_confirmation: true,
                    trend_filter: true
                }
            };
            return config;
        }

        async function runStrategyTest(isQuickTest = false) {
            const strategyConfig = getStrategyConfig();
            const symbol = document.getElementById('symbol').value;

            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('testResults').style.display = 'none';

            try {
                let endpoint, requestData;

                if (isQuickTest) {
                    endpoint = '/api/auth/quick-test-strategy';
                    requestData = {
                        strategy_config: strategyConfig,
                        symbol: symbol
                    };
                } else {
                    endpoint = '/api/auth/test-strategy';
                    requestData = {
                        strategy_config: strategyConfig,
                        symbol: symbol,
                        timeframe: '1h',
                        test_days: 90
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken') || ''
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    currentTestResults = data.results;
                    currentStrategyConfig = strategyConfig;
                    displayTestResults(data.results);
                } else {
                    throw new Error(data.detail || 'Test başarısız');
                }

            } catch (error) {
                alert('Hata: ' + error.message);
                console.error('Test error:', error);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function displayTestResults(results) {
            const metrics = results.metrics;
            const signalAnalysis = results.signal_analysis;
            const performanceSummary = results.performance_summary;

            // Display metric cards
            displayMetricCards(metrics, performanceSummary);

            // Display overview
            displayOverview(performanceSummary, metrics);

            // Display signals
            displaySignals(signalAnalysis);

            // Display chart
            displayChart(results.chart_data);

            // Display recommendations
            displayRecommendations(results.recommendations);

            // Show results and action buttons
            document.getElementById('testResults').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'block';

            // Show activate button if performance is good
            if (metrics.total_return_pct > 0 && metrics.max_drawdown_pct < 20) {
                document.getElementById('activateStrategyBtn').style.display = 'inline-block';
            }
        }

        function displayMetricCards(metrics, summary) {
            const container = document.getElementById('metricsCards');
            
            // Performance grade
            const gradeClass = getGradeClass(summary.performance_grade);
            
            container.innerHTML = `
                <div class="col-md-4">
                    <div class="metric-card ${gradeClass}">
                        <div class="performance-grade">${summary.performance_grade}</div>
                        <small>Performans Notu</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card ${getReturnClass(metrics.total_return_pct)}">
                        <h3>${metrics.total_return_pct.toFixed(1)}%</h3>
                        <small>Toplam Getiri</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card ${getDrawdownClass(metrics.max_drawdown_pct)}">
                        <h3>${metrics.max_drawdown_pct.toFixed(1)}%</h3>
                        <small>Maksimum Düşüş</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card">
                        <h3>${metrics.win_rate_pct.toFixed(1)}%</h3>
                        <small>Kazanma Oranı</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card">
                        <h3>${metrics.total_trades}</h3>
                        <small>Toplam İşlem</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card">
                        <h3>${summary.risk_level}</h3>
                        <small>Risk Seviyesi</small>
                    </div>
                </div>
            `;
        }

        function displayOverview(summary, metrics) {
            document.getElementById('performanceSummary').innerHTML = `
                <p><strong>Öneri:</strong> ${summary.recommendation}</p>
                <p>${summary.summary_text}</p>
                <hr>
                <p><strong>Sharpe Oranı:</strong> ${metrics.sharpe_ratio.toFixed(2)}</p>
                <p><strong>Kar Faktörü:</strong> ${metrics.profit_factor.toFixed(2)}</p>
                <p><strong>Ortalama İşlem:</strong> ${metrics.avg_trade_pct.toFixed(2)}%</p>
            `;

            document.getElementById('riskAnalysis').innerHTML = `
                <p><strong>En İyi İşlem:</strong> ${metrics.best_trade_pct.toFixed(2)}%</p>
                <p><strong>En Kötü İşlem:</strong> ${metrics.worst_trade_pct.toFixed(2)}%</p>
                <p><strong>Toplam Komisyon:</strong> $${metrics.total_fees.toFixed(2)}</p>
                <p><strong>İşlem Sıklığı:</strong> ${summary.trading_frequency}</p>
            `;
        }

        function displaySignals(signalAnalysis) {
            document.getElementById('signalStats').innerHTML = `
                <p><strong>Toplam Alış Sinyali:</strong> ${signalAnalysis.total_buy_signals}</p>
                <p><strong>Toplam Satış Sinyali:</strong> ${signalAnalysis.total_sell_signals}</p>
                <p><strong>Sinyal Kalite Puanı:</strong> ${signalAnalysis.signal_quality_score}/100</p>
                <p><strong>Sinyal Dengesi:</strong> ${signalAnalysis.signal_balance}</p>
            `;

            let recentSignalsHtml = '';
            signalAnalysis.recent_signals.forEach(signal => {
                const badgeClass = signal.type === 'BUY' ? 'signal-buy' : 'signal-sell';
                recentSignalsHtml += `
                    <div class="mb-2">
                        <span class="signal-badge ${badgeClass}">${signal.type}</span>
                        <small>${new Date(signal.date).toLocaleDateString('tr-TR')}</small>
                        <small>$${signal.price.toFixed(2)}</small>
                    </div>
                `;
            });

            document.getElementById('recentSignals').innerHTML = recentSignalsHtml || '<p>Sinyal bulunamadı</p>';
        }

        function displayChart(chartData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            const labels = chartData.timestamps.map(ts => new Date(ts).toLocaleDateString('tr-TR'));
            const prices = chartData.price_data.map(d => d.close);
            
            const buySignals = chartData.signals.filter(s => s.type === 'BUY');
            const sellSignals = chartData.signals.filter(s => s.type === 'SELL');

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Fiyat',
                        data: prices,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Fiyat ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tarih'
                            }
                        }
                    }
                }
            });
        }

        function displayRecommendations(recommendations) {
            let html = '';
            recommendations.forEach(rec => {
                html += `<div class="recommendation-item">${rec}</div>`;
            });
            document.getElementById('recommendationsList').innerHTML = html || '<p>Öneri yok</p>';
        }

        function showSaveStrategyModal() {
            const modal = new bootstrap.Modal(document.getElementById('saveStrategyModal'));
            
            // Pre-fill with strategy type and symbol
            const strategyType = document.getElementById('strategyType').value;
            const symbol = document.getElementById('symbol').value;
            document.getElementById('strategyName').value = `${strategyType}_${symbol}_${new Date().toISOString().slice(0, 10)}`;
            
            // Show warnings if any
            const metrics = currentTestResults.metrics;
            let warnings = [];
            if (metrics.total_return_pct < 0) warnings.push('⚠️ Strateji negatif getiri sağlıyor');
            if (metrics.max_drawdown_pct > 20) warnings.push('⚠️ Yüksek risk (>20% drawdown)');
            if (metrics.total_trades < 10) warnings.push('⚠️ Çok az işlem sayısı');
            
            if (warnings.length > 0) {
                document.getElementById('saveWarnings').innerHTML = `
                    <div class="alert alert-warning">
                        ${warnings.join('<br>')}
                    </div>
                `;
            } else {
                document.getElementById('saveWarnings').innerHTML = '';
            }
            
            modal.show();
        }

        async function saveStrategy() {
            const name = document.getElementById('strategyName').value;
            const description = document.getElementById('strategyDescription').value;

            if (!name.trim()) {
                alert('Strateji adı gerekli!');
                return;
            }

            try {
                const response = await fetch('/api/auth/save-tested-strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken') || ''
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        strategy_config: currentStrategyConfig,
                        test_results: currentTestResults
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Strateji başarıyla kaydedildi!');
                    bootstrap.Modal.getInstance(document.getElementById('saveStrategyModal')).hide();
                    
                    // Show activate button
                    document.getElementById('activateStrategyBtn').style.display = 'inline-block';
                    document.getElementById('activateStrategyBtn').onclick = () => activateStrategy(data.strategy.id);
                } else {
                    throw new Error(data.detail || 'Kaydetme başarısız');
                }

            } catch (error) {
                alert('Hata: ' + error.message);
                console.error('Save error:', error);
            }
        }

        async function activateStrategy(strategyId) {
            if (!confirm('Bu stratejiyi canlı ticarette kullanmak için aktifleştirmek istiyor musunuz?')) {
                return;
            }

            try {
                const response = await fetch(`/api/auth/strategies/${strategyId}/activate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken') || ''
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message + '\n\n' + (data.warning || ''));
                } else {
                    throw new Error(data.detail || 'Aktivasyon başarısız');
                }

            } catch (error) {
                alert('Hata: ' + error.message);
                console.error('Activation error:', error);
            }
        }

        // Helper functions
        function getGradeClass(grade) {
            switch(grade) {
                case 'A': return 'metric-positive';
                case 'B': return 'metric-positive';
                case 'C': return 'metric-neutral';
                case 'D': return 'metric-negative';
                case 'F': return 'metric-negative';
                default: return '';
            }
        }

        function getReturnClass(returnPct) {
            if (returnPct > 5) return 'metric-positive';
            if (returnPct < -2) return 'metric-negative';
            return 'metric-neutral';
        }

        function getDrawdownClass(drawdownPct) {
            if (drawdownPct < 5) return 'metric-positive';
            if (drawdownPct > 20) return 'metric-negative';
            return 'metric-neutral';
        }

        // Load predefined strategies
        document.getElementById('strategyType').addEventListener('change', function() {
            const strategyType = this.value;
            loadStrategyDefaults(strategyType);
        });

        function loadStrategyDefaults(strategyType) {
            const defaults = {
                quality_over_quantity: {
                    bbPeriod: 20, bbStd: 2.0,
                    macdFast: 12, macdSlow: 26, macdSignal: 9,
                    rsiPeriod: 14, rsiOverbought: 55, rsiOversold: 45,
                    positionSize: 5
                },
                trend_momentum: {
                    bbPeriod: 15, bbStd: 1.8,
                    macdFast: 8, macdSlow: 21, macdSignal: 5,
                    rsiPeriod: 9, rsiOverbought: 70, rsiOversold: 40,
                    positionSize: 8
                },
                volatility_breakout: {
                    bbPeriod: 10, bbStd: 1.5,
                    macdFast: 5, macdSlow: 13, macdSignal: 3,
                    rsiPeriod: 5, rsiOverbought: 80, rsiOversold: 20,
                    positionSize: 6
                }
            };

            const config = defaults[strategyType] || defaults.quality_over_quantity;
            
            document.getElementById('bbPeriod').value = config.bbPeriod;
            document.getElementById('bbStd').value = config.bbStd;
            document.getElementById('macdFast').value = config.macdFast;
            document.getElementById('macdSlow').value = config.macdSlow;
            document.getElementById('macdSignal').value = config.macdSignal;
            document.getElementById('rsiPeriod').value = config.rsiPeriod;
            document.getElementById('rsiOverbought').value = config.rsiOverbought;
            document.getElementById('rsiOversold').value = config.rsiOversold;
            document.getElementById('positionSize').value = config.positionSize;
            document.getElementById('positionSizeValue').textContent = config.positionSize + '%';
        }

        // Initialize with default values
        loadStrategyDefaults('quality_over_quantity');
    </script>
</body>
</html>